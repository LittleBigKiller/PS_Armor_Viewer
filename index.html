<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <title>Post Scriptum Armours</title>
        <style>
            html, body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }
        </style>
        <script src="https://cdn.babylonjs.com/babylon.js"></script>
        <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
        <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
        <script src="https://code.jquery.com/pep/0.4.3/pep.js"></script>
    </head>
   <body>
   <a href="https://github.com/dasu/PS_Armor_Viewer"><img src="git.png" style="position:absolute;bottom:0;left:0;width:2%"></a>
	<select id="dd" autocomplete="off" style="position:absolute;">
	  <optgroup label="Axis">
	    <option value="Jagdpanzer_IV">Jagdpanzer IV</option>
		<option value="Panzer_38t">Panzer 38t (Unreleased?)</option>
		<option value="Panzer_II">Panzer II (Unreleased?)</option>
		<option value="Panzer_III">Panzer III</option>
		<option value="Panzer_IV">Panzer IV</option>
		<option value="Panzer_V">Panzer V Panther</option>
		<option value="Panzer_VI_Tiger">Panzer VI Tiger</option>
		<option value="Sdkfz_222">Sd. Kfz 222</option>
		<option value="Sdkfz_232">Sd. Kfz 232</option>
		<option value="Sdkfz_234">Sd. Kfz 234 Puma</option>
		<option value="Stug_III">Stug III</option>
      </optgroup>
	  <optgroup label="UK">
	    <option value="Churchill_Mk_IV">Churchill Mk IV</option>
		<option value="Cromwell">Cromwell</option>
		<option value="Daimler">Daimler</option>
		<option value="Matilda">Matilda (Unreleased?)</option>
	    <option value="Sherman_Firefly" selected>Sherman Firefly</option>
		<option value="Staghound_T17">Staghound T17</option>
	  </optgroup>
	  <optgroup label="US">
	    <option value="M5_Stuart">M5 Stuart</option>
		<option value="M18_Hellcat">M18 Hellcat (Unreleased?)</option>
		<option value="Sherman_M4A3">Sherman M4A3</option>
	  </optgroup>
	  </select>
    <canvas id="renderCanvas" touch-action="none"></canvas> //touch-action="none" for best results from PEP
    <script>
		var canvas = document.getElementById("renderCanvas"); // Get the canvas element 
		var engine = new BABYLON.Engine(canvas, true); // Generate the BABYLON 3D engine
		var stackPanel = new BABYLON.GUI.StackPanel();
		var stackInternalPanel = new BABYLON.GUI.StackPanel();
		var stackOutside = new BABYLON.GUI.StackPanel();
		var lastclicked = null;
		/******* Add the create scene function ******/
		var createScene = function() {

			// Create the scene space
			var scene = new BABYLON.Scene(engine);
			stackPanel.width = 1;
			// Add a camera to the scene and attach it to the canvas
			var camera = new BABYLON.ArcRotateCamera("Camera", Math.PI / 2, Math.PI / 2, 20, new BABYLON.Vector3(0, 0, 0), scene);
			camera.attachControl(canvas, true);
			camera.wheelPrecision = 50.0;
			// Add lights to the scene
			var light1 = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(1, 1, 0), scene);
			// Add and manipulate meshes in the scene
			BABYLON.SceneLoader.ImportMesh("", "./new/", "fft.glb", scene, function(meshes) {
				//scene.createDefaultCameraOrLight(true, true, true);
				//scene.createDefaultEnvironment();
				var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

				//stackPanel.isVertical = false;
				//stackPanel.height = "100px";
				//stackPanel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
				stackPanel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
				stackInternalPanel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;

				//var stackOutside = new BABYLON.GUI.StackPanel();
				stackOutside.width = 1
				//stackOutside.isVertical = false;
				stackOutside.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
				stackOutside.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
				stackOutside.addControl(stackPanel);
				advancedTexture.addControl(stackOutside);
				advancedTexture.addControl(stackInternalPanel);
				var armourindex = []
				checkbox = checkbox = BABYLON.GUI.Checkbox.AddCheckBoxWithHeader('Internal Components', function(value) {
					if (value) {
						scene.meshes.forEach(function(mesh) {
							if (!mesh.material) {
								return;
							}
							if (mesh.material.name.match('Crew|Turret Ring|Ammo Rack|Tracks|Engine')) {
								mesh.material.transparencyMode = 0
								mesh.material.alpha = 1;
							} else {
								mesh.material.transparencyMode = 2
								mesh.material.alpha = 0.15;
							}
						});
					} else {
						if (!lastclicked) {
							scene.meshes.forEach(function(mesh) {
								if (!mesh.material) {
									return;
								}
								mesh.material.transparencyMode = 0
								mesh.material.alpha = 1;
							});
						}
					}
					lastclicked = null;
				});
				checkbox.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
				checkbox.children[0].isChecked = false;
				stackInternalPanel.addControl(checkbox);
				scene.meshes.forEach(function(mesh) {
					if (!mesh.material) {
						return;
					}
					if (!mesh.material.name.startsWith("MI_PS_Armor")) {
						if (mesh.material.name.match('Crew|Turret Ring|Ammo Rack|Tracks|Engine')) {
							if (armourindex.indexOf(mesh.material.name) > -1) {
								return;
							}
							var button = BABYLON.GUI.Button.CreateSimpleButton(mesh.material.name, mesh.material.name);
							armourindex.push(mesh.material.name);
							button.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
							button.width = 0.2;
							button.height = "30px";
							button.color = "#000000";
							button.background = mesh.material.albedoColor.toHexString();
							button.onPointerClickObservable.add(function(e, t) {
								if (t.target.name == lastclicked) {
									meshes.forEach(function(mesh) {
										if (!mesh.material) {
											return;
										}
										mesh.material.transparencyMode = 0
										mesh.material.alpha = 1;
									});
									lastclicked = null;
									return;
								} else {
									scene.meshes.forEach(function(mesh) {
										if (!mesh.material) {
											return;
										}
										if (mesh.material.name == t.target.name) {
											mesh.material.transparencyMode = 0
											mesh.material.alpha = 1;
										} else {
											mesh.material.transparencyMode = 2
											mesh.material.alpha = 0.15;
										}
									});
								}
								lastclicked = t.target.name;
								checkbox.children[0].isChecked = false;
							});
							stackInternalPanel.addControl(button);
						}
						return;
					}
					if (armourindex.indexOf(mesh.material.name) > -1) {
						return;
					}
					var button = BABYLON.GUI.Button.CreateSimpleButton(mesh.material.name, mesh.material.name);
					armourindex.push(mesh.material.name);
					button.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
					button.width = 0.2;
					button.height = "30px";
					button.color = "#000000";
					button.background = mesh.material.albedoColor.toHexString();
					button.onPointerClickObservable.add(function(e, t) {
						if (t.target.name == lastclicked) {
							meshes.forEach(function(mesh) {
								if (!mesh.material) {
									return;
								}
								mesh.material.transparencyMode = 0
								mesh.material.alpha = 1;
							});
							lastclicked = null;
							return;
						} else {
							scene.meshes.forEach(function(mesh) {
								if (!mesh.material) {
									return;
								}
								if (mesh.material.name == t.target.name) {
									mesh.material.transparencyMode = 0
									mesh.material.alpha = 1;
								} else {
									mesh.material.transparencyMode = 2
									mesh.material.alpha = 0.15;
								}
							});
						}
						lastclicked = t.target.name;
						checkbox.children[0].isChecked = false;
					});
					stackPanel.addControl(button);
				})
				var armourindex = [];
			});

			return scene;
		};
		/******* End of the create scene function ******/

		var scene = createScene(); //Call the createScene function

		// Register a render loop to repeatedly render the scene
		engine.runRenderLoop(function() {
			scene.render();
		});

		// Watch for browser/canvas resize events
		window.addEventListener("resize", function() {
			engine.resize();
		});

		document.getElementById("dd").addEventListener("change", function() {
			file = document.getElementById("dd").value
			scene.meshes.forEach(function(mesh) {
				mesh.dispose()
			})
			stackPanel.clearControls();
			stackInternalPanel.clearControls();
			BABYLON.SceneLoader.ImportMesh("", "./new/", file + ".glb", scene, function(meshes) {
				var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
				stackPanel.clearControls();
				stackPanel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
				stackInternalPanel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
				var stackOutside = new BABYLON.GUI.StackPanel();
				stackOutside.width = 1;
				stackOutside.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
				stackOutside.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
				stackOutside.addControl(stackPanel);
				advancedTexture.addControl(stackOutside);
				advancedTexture.addControl(stackInternalPanel);
				var armourindex = [];
				checkbox = checkbox = BABYLON.GUI.Checkbox.AddCheckBoxWithHeader('Internal Components', function(value) {
					if (value) {
						scene.meshes.forEach(function(mesh) {
							if (!mesh.material) {
								return;
							}
							if (mesh.material.name.match('Crew|Turret Ring|Ammo Rack|Tracks|Engine')) {
								mesh.material.transparencyMode = 0
								mesh.material.alpha = 1;
							} else {
								mesh.material.transparencyMode = 2
								mesh.material.alpha = 0.15;
							}
						});
					} else {
						if (!lastclicked) {
							scene.meshes.forEach(function(mesh) {
								if (!mesh.material) {
									return;
								}
								mesh.material.transparencyMode = 0
								mesh.material.alpha = 1;
							});
						}
					}
					lastclicked = null;
				});
				checkbox.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
				checkbox.children[0].isChecked = false;
				stackInternalPanel.addControl(checkbox);

				scene.meshes.forEach(function(mesh) {
					if (!mesh.material) {
						return;
					}
					if (!mesh.material.name.startsWith("MI_PS_Armor")) {
						if (mesh.material.name.match('Crew|Turret Ring|Ammo Rack|Tracks|Engine')) {
							if (armourindex.indexOf(mesh.material.name) > -1) {
								return;
							}
							var button = BABYLON.GUI.Button.CreateSimpleButton(mesh.material.name, mesh.material.name);
							armourindex.push(mesh.material.name);
							button.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
							button.width = 0.2;
							button.height = "30px";
							button.color = "#000000";
							button.background = mesh.material.albedoColor.toHexString();
							button.onPointerClickObservable.add(function(e, t) {
								if (t.target.name == lastclicked) {
									meshes.forEach(function(mesh) {
										if (!mesh.material) {
											return;
										}
										mesh.material.transparencyMode = 0
										mesh.material.alpha = 1;
									});
									lastclicked = null;
									return;
								} else {
									scene.meshes.forEach(function(mesh) {
										if (!mesh.material) {
											return;
										}
										if (mesh.material.name == t.target.name) {
											mesh.material.transparencyMode = 0
											mesh.material.alpha = 1;
										} else {
											mesh.material.transparencyMode = 2
											mesh.material.alpha = 0.15;
										}
									});
								}
								lastclicked = t.target.name;
								checkbox.children[0].isChecked = false;
							});
							stackInternalPanel.addControl(button);
						}
						return;
					}
					if (armourindex.indexOf(mesh.material.name) > -1) {
						return;
					}
					var button = BABYLON.GUI.Button.CreateSimpleButton(mesh.material.name, mesh.material.name);
					armourindex.push(mesh.material.name);
					button.width = 0.2;
					button.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
					button.height = "30px";
					button.color = "#000000";
					button.background = mesh.material.albedoColor.toHexString();
					button.onPointerClickObservable.add(function(e, t) {
						if (t.target.name == lastclicked) {
							meshes.forEach(function(mesh) {
								if (!mesh.material) {
									return;
								}
								mesh.material.transparencyMode = 0
								mesh.material.alpha = 1;
							});
							lastclicked = null;
							return;
						} else {
							scene.meshes.forEach(function(mesh) {
								if (!mesh.material) {
									return;
								}
								if (mesh.material.name == t.target.name) {
									mesh.material.transparencyMode = 0
									mesh.material.alpha = 1;
								} else {
									mesh.material.transparencyMode = 2
									mesh.material.alpha = 0.15;
								}
							});
						}
						lastclicked = t.target.name;
						checkbox.children[0].isChecked = false;
					});
					stackPanel.addControl(button);
				})
				var armourindex = [];
			})
		});
    </script>
   </body>
</html>
